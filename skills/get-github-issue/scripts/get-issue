#!/bin/bash
#
# Get a GitHub issue from the current repository using the GitHub API
#
# Requirements:
#   - GITHUB_PAT environment variable must be set with a valid GitHub Personal Access Token
#   - curl and jq must be installed
#   - Must be run from within a git repository with a GitHub remote
#
# Usage:
#   get-issue <issue-number>
#

set -e

# Check for issue number argument
if [[ $# -lt 1 ]]; then
    echo "Error: Issue number is required" >&2
    echo "Usage: $0 <issue-number>" >&2
    exit 1
fi

ISSUE_NUMBER="$1"

# Validate issue number is a positive integer
if ! [[ "$ISSUE_NUMBER" =~ ^[0-9]+$ ]]; then
    echo "Error: Issue number must be a positive integer" >&2
    exit 1
fi

# Validate GITHUB_PAT
if [[ -z "$GITHUB_PAT" ]]; then
    echo "Error: GITHUB_PAT environment variable is not set" >&2
    echo "Please set GITHUB_PAT with a valid GitHub Personal Access Token" >&2
    exit 1
fi

# Get the repository from git remote
REMOTE_URL=$(git remote get-url origin 2>/dev/null) || {
    echo "Error: Not a git repository or no 'origin' remote found" >&2
    exit 1
}

# Extract owner/repo from remote URL (handles both HTTPS and SSH formats)
if [[ "$REMOTE_URL" =~ github\.com[:/]([^/]+)/([^/.]+)(\.git)?$ ]]; then
    REPO="${BASH_REMATCH[1]}/${BASH_REMATCH[2]}"
else
    echo "Error: Could not parse GitHub repository from remote URL: $REMOTE_URL" >&2
    exit 1
fi

# Make the API request
API_URL="https://api.github.com/repos/${REPO}/issues/${ISSUE_NUMBER}"

RESPONSE=$(curl -s -w "\n%{http_code}" \
    -X GET \
    -H "Accept: application/vnd.github+json" \
    -H "Authorization: Bearer ${GITHUB_PAT}" \
    -H "X-GitHub-Api-Version: 2022-11-28" \
    "$API_URL")

# Extract HTTP status code and response body
HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')

# Check for success
if [[ "$HTTP_CODE" -eq 200 ]]; then
    TITLE=$(echo "$RESPONSE_BODY" | jq -r '.title')
    BODY=$(echo "$RESPONSE_BODY" | jq -r '.body // ""')

    # Return title and content as a single string
    echo "$TITLE"
    if [[ -n "$BODY" ]]; then
        echo ""
        echo "$BODY"
    fi
else
    echo "Error: Failed to get issue #${ISSUE_NUMBER} (HTTP ${HTTP_CODE})" >&2
    echo "$RESPONSE_BODY" | jq -r '.message // .' >&2
    exit 1
fi
